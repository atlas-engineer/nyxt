app-id: engineer.atlas.Nyxt
# Not a mistake! We need the sonames of shared libraries for SBCL during runtime.
runtime: org.gnome.Sdk
runtime-version: "41"
sdk: org.gnome.Sdk
command: nyxt

finish-args:
  - --device=dri
  - --share=network
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --socket=cups
  - --filesystem=xdg-documents
  - --filesystem=xdg-download
  - --filesystem=xdg-music
  - --filesystem=xdg-videos
  - --filesystem=xdg-pictures
  - --talk-name=org.a11y.Bus

modules:
  - name: sbcl
    buildsystem: simple
    sources:
      - type: archive
        url: http://prdownloads.sourceforge.net/sbcl/sbcl-2.0.11-x86-64-linux-binary.tar.bz2
        sha256: b7e61bc6b8d238f8878e660bc0635e99c2ea1255bfd6153d702fe9a00f8138fd
    build-options:
      env:
        BUILD_ROOT: "/app/sbcl"
    build-commands:
      - sh install.sh

  - name: libfixposix
    buildsystem: autotools
    sources:
      - type: git
        url: https://github.com/sionescu/libfixposix.git
        tag: v0.4.3
      - type: script
        dest-filename: autogen.sh
        commands:
          - autoreconf -fi

  - name: nyxt
    buildsystem: simple
    sources:
      - type: file
        url: https://github.com/atlas-engineer/nyxt/releases/download/3-pre-release-3/nyxt-3-pre-release-3-source-with-submodules.tar.xz
        sha256: f5f13c78ed89aa41813c702b8ee04597e976b8d1c3a78ac7c8f6b706e11b8cda
        dest-filename: nyxt.tar.xz
        only-arches: [x86_64]
      - type: file
        path: engineer.atlas.Nyxt.appdata.xml
    build-options:
      no-debuginfo: false
      env:
        LISP: "/app/sbcl/usr/local/bin/sbcl"
        LISP_FLAGS: "--dynamic-space-size 4096 --no-userinit --non-interactive"
    build-commands:
      - tar xvf nyxt.tar.xz
      - make all
      - mkdir $FLATPAK_DEST/bin
      - mv nyxt $FLATPAK_DEST/bin/
      - install -D engineer.atlas.Nyxt.appdata.xml /app/share/appdata/engineer.atlas.Nyxt.appdata.xml
